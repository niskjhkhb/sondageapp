<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Création de sondages</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    header {
     
      position: static;
      width: 100%;
      z-index: 1000;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo {
      font-size: 1.8rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-decoration: none;
      z-index: 1001;
    }
    nav a {
      color: var(--text-secondary);
      font-weight: 500;
      margin-left: 1rem;
      text-decoration: none;
      transition: color 0.3s ease;
    }
    nav a:hover {
      color: var(--text);
    }
    body {
      background: #0F172A;
      color: #F8FAFC;
      font-family: 'Poppins', sans-serif;
      min-height: 100vh;
      padding: 2rem;
    }
    h1 {
      margin-bottom: 1rem;
      color: #4F46E5;
    }
    .question-block {
      background: #1E293B;
      border-radius: 12px;
      padding: 1rem 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 0 10px rgba(79, 70, 229, 0.3);
    }
    label {
      font-weight: 600;
      margin-top: 0.5rem;
    }
    input[type="text"], select, textarea {
      background: #2D3B55;
      border: none;
      color: #F8FAFC;
      padding: 0.5rem;
      width: 100%;
      border-radius: 6px;
      margin-top: 0.3rem;
      margin-bottom: 1rem;
      font-size: 1rem;
    }
    button {
      cursor: pointer;
    }
    .btn-primary {
      background: #4F46E5;
      border: none;
      padding: 0.5rem 1.5rem;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      margin-top: 1rem;
      transition: background 0.3s ease;
    }
    .btn-primary:hover {
      background: #7C3AED;
    }
    .choice-input {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.8rem;
    }
    .choice-input input[type="text"] {
      flex-grow: 1;
    }
    .btn-add-choice {
      background: #06B6D4;
      border: none;
      color: white;
      padding: 0.3rem 0.8rem;
      border-radius: 6px;
      font-weight: 600;
    }
    .btn-add-choice:hover {
      background: #0891B2;
    }
    .conditional-block {
      background: #334155;
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
    <header>
  <a href="{% url 'home' %}" class="logo">SurveyPro</a>
  <nav>
    <a href="{% url 'dashboard' %}"><i class="fas fa-chart-bar"></i> Dashboard</a>
    <a href="{% url 'create_sondage' %}"><i class="fas fa-plus-circle"></i> Create</a>
    <a href="{% url 'logout' %}"><i class="fas fa-sign-out-alt"></i> Logout</a>
  </nav>
</header>

  <h1>Création de sondages</h1>

  <form id="surveyForm">

    <div id="questionsContainer"></div>

    <button type="button" id="addQuestionBtn" class="btn btn-primary">+ Ajouter une question</button>
    <button type="submit" class="btn btn-primary">Soumettre le sondage</button>
  </form>

  <script>
    let questionCount = 0;

    const questionsContainer = document.getElementById('questionsContainer');
    const addQuestionBtn = document.getElementById('addQuestionBtn');

    // Question types options
    const questionTypes = {
      sc: 'Choix unique',
      mc: 'Choix multiple',
      scale: 'Échelle',
      text: 'Texte libre',
    };

    // Render a new question block
    function createQuestionBlock(index) {
      const div = document.createElement('div');
      div.className = 'question-block';
      div.dataset.index = index;

      div.innerHTML = `
        <label>Question ${index + 1} :</label>
        <input type="text" name="questions[${index}][text]" placeholder="Entrez la question" required />

        <label>Type de question :</label>
        <select name="questions[${index}][type]" required>
          ${Object.entries(questionTypes).map(([val, label]) => `<option value="${val}">${label}</option>`).join('')}
        </select>

        <div class="answers-container"></div>

        <button type="button" class="btn-add-choice" style="display:none;">+ Ajouter un choix</button>

        <div class="conditional-block" style="display:none;">
          <label>Condition logique (optionnel) :</label>
          <select name="questions[${index}][condition][question]">
            <option value="">-- Sélectionnez une question --</option>
          </select>
          <input type="text" name="questions[${index}][condition][value]" placeholder="Valeur de la réponse" />
          <small style="color:#bbb;">Cette question apparaîtra uniquement si la condition est remplie.</small>
        </div>
      `;

      // Add listeners to handle type changes and adding choices
      const selectType = div.querySelector('select[name^="questions"][name$="[type]"]');
      const answersContainer = div.querySelector('.answers-container');
      const addChoiceBtn = div.querySelector('.btn-add-choice');
      const conditionalBlock = div.querySelector('.conditional-block');
      const conditionQuestionSelect = conditionalBlock.querySelector('select');

      // Populate conditional question options
      function updateConditionOptions() {
        conditionQuestionSelect.innerHTML = '<option value="">-- Sélectionnez une question --</option>';
        for(let i = 0; i < questionCount; i++) {
          if(i === index) continue; // no self reference
          const qText = document.querySelector(`.question-block[data-index="${i}"] input[name="questions[${i}][text]"]`).value || `Question ${i+1}`;
          conditionQuestionSelect.innerHTML += `<option value="${i}">${qText}</option>`;
        }
      }
      updateConditionOptions();

      // Render answers input based on type
      function renderAnswers(type) {
        answersContainer.innerHTML = '';
        addChoiceBtn.style.display = 'none';

        if(type === 'sc' || type === 'mc') {
          addChoiceBtn.style.display = 'inline-block';
          addChoiceBtn.onclick = () => addChoice(answersContainer, index);
          // Start with 2 choices
          addChoice(answersContainer, index);
          addChoice(answersContainer, index);
        } else if(type === 'scale') {
          answersContainer.innerHTML = `
            <label>Valeur minimale :</label>
            <input type="number" name="questions[${index}][scale_min]" value="1" required />
            <label>Valeur maximale :</label>
            <input type="number" name="questions[${index}][scale_max]" value="5" required />
            <label>Libellé des points (optionnel, séparés par des virgules) :</label>
            <input type="text" name="questions[${index}][scale_labels]" placeholder="Ex: Mauvais, Moyen, Excellent" />
          `;
        } else if(type === 'text') {
          answersContainer.innerHTML = `<label>Réponse texte libre :</label><textarea name="questions[${index}][text_response]" rows="3" placeholder="Réponse libre"></textarea>`;
        }
      }

      selectType.addEventListener('change', e => {
        renderAnswers(e.target.value);
        conditionalBlock.style.display = 'block'; // show conditional logic for all
        updateConditionOptions();
      });

      // Initialize with single choice type
      renderAnswers(selectType.value);
      conditionalBlock.style.display = 'block';

      return div;
    }

    // Add a choice input field for sc/mc questions
    function addChoice(container, questionIndex) {
      const choiceCount = container.querySelectorAll('.choice-input').length;
      const div = document.createElement('div');
      div.className = 'choice-input';

      div.innerHTML = `
        <input type="text" name="questions[${questionIndex}][choices][${choiceCount}]" placeholder="Option ${choiceCount + 1}" required />
        <button type="button" style="background:#ef4444; color:white; border:none; border-radius:4px; padding:0 8px;">x</button>
      `;

      div.querySelector('button').onclick = () => {
        div.remove();
        // Re-index choices
        const choices = container.querySelectorAll('.choice-input input[type="text"]');
        choices.forEach((input, i) => {
          input.name = `questions[${questionIndex}][choices][${i}]`;
          input.placeholder = `Option ${i+1}`;
        });
      };

      container.appendChild(div);
    }

    addQuestionBtn.onclick = () => {
      questionsContainer.appendChild(createQuestionBlock(questionCount));
      questionCount++;
      updateAllConditionOptions();
    };

    // Update conditional dropdowns for all questions
    function updateAllConditionOptions() {
      for(let i = 0; i < questionCount; i++) {
        const conditionalBlock = document.querySelector(`.question-block[data-index="${i}"] .conditional-block`);
        if(!conditionalBlock) continue;
        const select = conditionalBlock.querySelector('select');
        select.innerHTML = '<option value="">-- Sélectionnez une question --</option>';
        for(let j = 0; j < questionCount; j++) {
          if(j === i) continue;
          const qText = document.querySelector(`.question-block[data-index="${j}"] input[name="questions[${j}][text]"]`).value || `Question ${j+1}`;
          select.innerHTML += `<option value="${j}">${qText}</option>`;
        }
      }
    }

    // Initialize with one question
    addQuestionBtn.click();

    // Optional: Handle form submit
    document.getElementById('surveyForm').addEventListener('submit', e => {
      e.preventDefault();

      const data = new FormData(e.target);

      // For demo, just log all form entries
      console.log('Form data:');
      for(const pair of data.entries()) {
        console.log(pair[0]+ ': ' + pair[1]);
      }

      alert('Sondage soumis (voir console pour données)');
    });
  </script>

</body>
</html>
